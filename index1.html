<html>
    <head>
        <title>three.js webgl - collision detection</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <style type="text/css">

            body {
                font-family: Monospace;
                background-color: #f0f0f0;
                margin: 0px;
                overflow: hidden;
            }

        </style>

        <script type="text/javascript" src="Three.js"></script>
        <script type="text/javascript" src="RequestAnimationFrame.js"></script>

        <script type="text/javascript">

            var camera, scene, renderer, info, mouse2d, sun, ball, my_bat, mouseX, mouseY;

            var initial_y_speed = 0.1;
            var speed = 5.5, sphereSize = 4, y_speed = initial_y_speed;
            var a = 10, t = 0, direction = 1;
            
			      var windowHalfX = window.innerWidth / 2;
			      var windowHalfY = window.innerHeight / 2;
			      
            var reversed = false;
            
            function init(){
                container = document.createElement('div');
                document.body.appendChild(container);

                info = document.getElementById("info");

                camera = new THREE.Camera(60, window.innerWidth / window.innerHeight, 1, 10000);
		            camera.position.y = 150;
            		camera.position.x = 500;
		            camera.position.z = 0;

                mouse2d = new THREE.Vector3( 0, 0, 1 );

                scene = new THREE.Scene();

                ball = new THREE.Mesh( new THREE.SphereGeometry( sphereSize, 10, 10 ), new THREE.MeshBasicMaterial( { color: 0xffff00 } ) );
                ball.position = new THREE.Vector3( 0, 0, -390 );
                scene.addObject( ball );

                renderer = new THREE.CanvasRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.appendChild(renderer.domElement);

                createObstacles();

                container.onmousemove = onDocumentMouseMove;
                animate();
            }

            function createObstacles(){
				      createCube(100, 100, 10, new THREE.Vector3(0, 0, -400), 0x003300);
              createCube(400, 10, 800, new THREE.Vector3(0, -50, 0), 0x2c2dee); // table
				      my_bat = createCube(100, 100, 10, new THREE.Vector3(0, 0, 400), 0x003300);
            }

            function createCube(sx, sy, sz, p, color){
              var cube = new THREE.Mesh(new THREE.CubeGeometry( sx, sy, sz ), new THREE.MeshBasicMaterial( { color: color } ) );
              cube.position = p;
              scene.addObject(cube);
              THREE.Collisions.colliders.push( THREE.CollisionUtils.MeshOBB(cube) );
				      return cube;
            }

            function onDocumentMouseMove(event){
              event.preventDefault();
       				mouseX = ( event.clientX - windowHalfX );
      				mouseY = ( event.clientY - windowHalfY );
            }

            function animate(){
              requestAnimationFrame(animate);

              ball.position.z += speed;
              
              // table collision
  		        var table_ray = new THREE.Ray( ball.position, new THREE.Vector3(0,-1,0) );
			        var c = THREE.Collisions.rayCastNearest(table_ray);
			        if(c && (c.distance < 4) && (c.distance != -1)) {
			          direction = -direction;			          
			        }

              y_speed = initial_y_speed + a * t;
              
			        if(direction > 0) {
                ball.position.y -= y_speed;
              } else {
                ball.position.y += y_speed;
              }
              
              t += 0.001;
              
              // collisions with bats
  		        var bats_ray = new THREE.Ray( ball.position, new THREE.Vector3(0,0,1) );

			        var c = THREE.Collisions.rayCastNearest(bats_ray);
  
	            // collided with left bat
	  		      if(c && (c.distance < 10) && (c.distance != -1)) {
  				      //info.innerHTML = 'a: ' + c.distance;//"Colliding!";
				        speed = -speed;
				        reversed = true;
				        t = 0.001;
				        direction = -direction;
			        } else if(c && c.distance >= 800) { // collided with right bat
			          if(reversed) {
   				        t = 0.001;
 				          speed = -speed;
 				          reversed = false;
 				        }
			        }

			        //camera.position.x = Math.cos(mouse2d.x * Math.PI) * 300;
		          //camera.position.z = 200 + Math.sin(mouse2d.x * Math.PI) * 300;
              my_bat.position.x = mouseX;
              
              renderer.render(scene, camera);
            }
        </script>
    </head>
    <body onload="init();">
        <div id="info">
        </div>
        <div id="options">
        </div>
    </body>
</html>
