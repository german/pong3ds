<html>
    <head>
        <title>Pong 3d (build with three.js 3d javascript language, node.js, socket.io)</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <style type="text/css">
          body {
            font-family: Monospace;
            background-color: #f0f0f0;
            margin: 0px;
            overflow: hidden;
          }
          
          .list_of_rooms {
            position:absolute;
            top:120px;
            left:20px;
            width:215px;
            padding:5px;
            border:1px solid green;
          }
        </style>

        <script type="text/javascript" src="Three.js"></script>
        <script type="text/javascript" src="RequestAnimationFrame.js"></script>
        <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
        <script type="text/javascript" src="facebox.js"></script>
        
        <script src="socket.io/socket.io.min.js"></script>
        
        <script type="text/javascript">
            $.facebox.settings.closeImage = 'images/closelabel.png';
            $.facebox.settings.loadingImage = 'images/loading.gif';
            
            var camera, scene, renderer, info, mouse2d, sun, ball, my_bat, mouseX, mouseY;

            var initial_y_speed = 0.1;
            var speed = 5.5, sphereSize = 4, y_speed = initial_y_speed;
            var a = 10, t = 0, direction = 1;
            
			      var windowHalfX = window.innerWidth / 2;
			      var windowHalfY = window.innerHeight / 2;
			      
			      var room_id;
			      
            var reversed = false;
            
            var socket = io.connect('http://localhost:8080');
                            
            socket.on('player_connected', function (msg) {
              console.log('msg - ' + msg.player_id);
            });

            socket.on('round_could_be_started', function(msg){
              console.log('round could be started');
              jQuery.facebox.close();
              jQuery('.list_of_rooms').hide();
              init();
            });
            
            socket.on('list_of_rooms', function (list) {
              console.log('got list of rooms');
              show_list_of_rooms(list);
            });
                            
            function show_list_of_rooms(list) {
              $('.form_for_list_of_rooms').html('');
              var img_for_room, is_room_disabled_for_select = '';
              for(var i = 0; i < list.number_of_rooms; i++) {
                switch(list.rooms[i].number_of_connected_players) {
                  case 0:
                    img_for_room = '<img src="images/green_dot.png" width="12" height="12" alt="Available"/ >';
                    is_room_disabled_for_select = '';
                    break;
                  case 1:
                    img_for_room = '<img src="images/yellow_dot.png" width="12" height="11" alt="Available"/ >';
                    is_room_disabled_for_select = ''
                    break;
                  case 2:
                    img_for_room = '<img src="images/red_dot.png" width="12" height="11" alt="Full"/ >';
                    is_room_disabled_for_select = 'disabled';
                    break;
                }
                $('.form_for_list_of_rooms').append(img_for_room+'<input type="radio" name="room_id" onclick="window.room_id=parseInt(this.value)" '+is_room_disabled_for_select+' value="' + i + '"> #' + i + " [" + list.rooms[i].number_of_connected_players + "] players <br/ >");
              }
              $('.form_for_list_of_rooms').append('<input type="submit" value="Connect"/ >');
            }
            
            function init(){
              container = document.createElement('div');
              document.body.appendChild(container);

              info = document.getElementById("info");

              camera = new THREE.Camera(60, window.innerWidth / window.innerHeight, 1, 10000);
		          camera.position.y = 150;
            	camera.position.x = 500;
		          camera.position.z = 0;

              mouse2d = new THREE.Vector3( 0, 0, 1 );

              scene = new THREE.Scene();

              ball = new THREE.Mesh( new THREE.SphereGeometry( sphereSize, 10, 10 ), new THREE.MeshBasicMaterial( { color: 0xffff00 } ) );
              ball.position = new THREE.Vector3( 0, 0, -390 );
              scene.addObject( ball );

              renderer = new THREE.CanvasRenderer();
              renderer.setSize(window.innerWidth, window.innerHeight);
              container.appendChild(renderer.domElement);

              createObstacles();

              container.onmousemove = onDocumentMouseMove;
                                
              animate();
            }

            function createObstacles(){
				      createCube(100, 100, 10, new THREE.Vector3(0, 0, -400), 0x003300);
              createCube(400, 10, 800, new THREE.Vector3(0, -50, 0), 0x2c2dee); // table
				      my_bat = createCube(100, 100, 10, new THREE.Vector3(0, 0, 400), 0x003300);
            }

            function createCube(sx, sy, sz, p, color){
              var cube = new THREE.Mesh(new THREE.CubeGeometry( sx, sy, sz ), new THREE.MeshBasicMaterial( { color: color } ) );
              cube.position = p;
              scene.addObject(cube);
              THREE.Collisions.colliders.push( THREE.CollisionUtils.MeshOBB(cube) );
				      return cube;
            }

            function onDocumentMouseMove(event){
              event.preventDefault();
       				mouseX = ( event.clientX - windowHalfX );
      				mouseY = ( event.clientY - windowHalfY );
            }

            function animate(){
              requestAnimationFrame(animate);

              ball.position.z += speed;
              
              // table collision
  		        var table_ray = new THREE.Ray( ball.position, new THREE.Vector3(0,-1,0) );
			        var c = THREE.Collisions.rayCastNearest(table_ray);
			        if(c && (c.distance < 4) && (c.distance != -1)) {
			          direction = -direction;			          
			        }

              y_speed = initial_y_speed + a * t;
              
			        if(direction > 0) {
                ball.position.y -= y_speed;
              } else {
                ball.position.y += y_speed;
              }
              
              t += 0.001;
              
              // collisions with bats
  		        var bats_ray = new THREE.Ray( ball.position, new THREE.Vector3(0,0,1) );

			        var c = THREE.Collisions.rayCastNearest(bats_ray);
  
	            // collided with left bat
	  		      if(c && (c.distance < 10) && (c.distance != -1)) {
  				      //info.innerHTML = 'a: ' + c.distance;//"Colliding!";
				        speed = -speed;
				        reversed = true;
				        t = 0.001;
				        direction = -direction;
			        } else if(c && c.distance >= 800) { // collided with right bat
			          if(reversed) {
   				        t = 0.001;
 				          speed = -speed;
 				          reversed = false;
 				        }
			        }

			        //camera.position.x = Math.cos(mouse2d.x * Math.PI) * 300;
		          //camera.position.z = 200 + Math.sin(mouse2d.x * Math.PI) * 300;
              my_bat.position.x = mouseX;
              
              renderer.render(scene, camera);
            }
        </script>
    </head>
    <body> <!-- onload="init();" -->
      <div id="info"></div>
      <div id="options"></div>
      
      <div class="list_of_rooms">
        <h3>Please select to which room you want to connect:</h3>
        
        <form class="form_for_list_of_rooms" onsubmit="if(typeof window.room_id != 'undefined') {$('.errors_for_list_of_rooms').hide(); socket.emit('connect', {room_id: window.room_id}); jQuery.facebox.close();} else { $('.errors_for_list_of_rooms').show() }; return false;"></form>
        
        <div class="errors_for_list_of_rooms" style="color:red;font-size:16px;float:left;display:none">You should specify which room do you want to play in</div>
      </div>
      
      <script type="text/javascript">
        jQuery.facebox({ div: '.list_of_rooms' });
      </script>
    </body>
</html>
